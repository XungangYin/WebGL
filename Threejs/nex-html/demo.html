<!DOCTYPE html>
<html lang="en">
<title>Demo  </title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>body { margin: 0px; overflow: hidden; }</style>
<link type="text/css" rel="stylesheet" href="stylesheet/3dhop.css"/> <!--链接样式表sst的通用方式 -->

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.js"></script>-->
<script src="../js/three.js"></script>

<script src="../js/libs/CanvasRenderer.js"></script>
<!--JQUERY-->
<script src="js/jquery.js"></script>
<script src="js/TrackballControls.js"></script>

<script src="js/nexus.js"></script>
<script src="js/nexus_three.js"></script>
<!--<script src = "../js/libs/stats.min.js"></script>-->
<!--<script src = "../js/libs/dat.gui.min.js"></script>-->

<script src="../js/libs/inflate.min.js"></script>
<script src = "../js/loaders/OBJLoader.js"></script>


<script src = "js/init.js"></script>

<script src="../js/loaders/TGALoader_dev.js"></script>
<script src="../js/loaders/GLTFLoader.js"></script>
<script src = "../js/utils/GeometryUtils.js"></script>
<script src = "js/CSS2DRenderer.js"></script>
<script src="js/OrbitControls.js"></script>



</head>

<body>
<div id="container"></div>
<!--<canvas id="container"></canvas>-->
<div id="event" class ="3DModel" onmousedown="if(event.preventDefault) event.preventDefault() "></div>
<div id="toolbar">
    <img id="home" 		 	title="Home" 					src="img/dark/home.png"/><br/>
    <img id="zoomin" 	    title="Zoom In"					src="img/dark/zoomin.png"/><br/>
    <img id="light_on"      title="Disable Light Control"   src="img/dark/lightcontrol_on.png" style="position:absolute; visibility:hidden;"/>
    <img id="light"      	title="Enable Light Control"    src="img/dark/lightcontrol.png"    /><br/>
    <img id="measure_on"	title="Disable Measure tool"	src="img/dark/measure_on.png" style="..."/>
    <!--<img id="measure"		title="Enable Measure tool"		src="img/dark/measure.png"/><br/>-->

</div>

<div id="measure-box" class="output-box">Measured length<hr/><span id="measure-output" class="output-text" onmousedown="event.stopPropagation()">0.0</span></div>

</body>
<script>
    //var container = document.getElementById( 'container');
    var renderer,scene,camera;
    var stats,controls;
    var mix;

    var raycaster,mouse,particleMaterial,labelRenderer;

    var clock = new THREE.Clock();
    var cloc1 = new THREE.Clock();
    var loader  = new THREE.OBJLoader();

    renderer= new THREE.WebGLRenderer( { antialias: false } );
    renderer.setClearColor( 0xffffff );
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( window.innerWidth, window.innerHeight);
    //document.getElementById('container').appendChild(renderer.domElement);
    document.body.appendChild(renderer.domElement);
    //container.appendChild( renderer.domElement );us

    camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 0.001, 800 );
    //camera.position.z = 2.2;
    camera.position.set(0.308620,0.238,1.07); //北航研究院
  //  camera.position.set(0.308620,2.438,1.07);
    //	camera.position.set(0,-1,0.5); //天津
    camera.lookAt({x:0,y:0,z:0});
   // controls = new THREE.TrackballControls( camera,renderer.domElement ); //第二个参数防止该漫游器和dat.gui冲突
//    controls = new THREE.TrackballControls( camera );
    controls = new THREE.OrbitControls( camera );

    controls.rotateSpeed = 1.0;
    controls.zoomSpeed = 1.5;
    controls.panSpeed = 0.8;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = true;
    controls.dynamicDampingFactor = 0.3;

    controls.maxPolarAngle = Math.PI*0.45;
    controls.minDistance = 0.3;
    controls.maxDistance = 3;


    scene = new THREE.Scene();
    scene.add( new THREE.AmbientLight( 0x555555 ) );

    var light1 = new THREE.DirectionalLight( 0xdddddd, 1.0 );
    light1.position.set(0, 1, 1 );
    scene.add( light1 );

    var light2 = new THREE.DirectionalLight( 0x777777, 1.0 );
    light2.position.set( 1, -1, 0);
    scene.add( light2 );

    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
    }

    var model = getURLParameter('model') || "models/xx.nxz";   //corto压缩后.北航青岛

    var nexus_obj = new NexusObject( model, renderer, render /*,material*/);
   // nexus_obj.instance.setTargetError = 0.5;
   // nexus_obj.instance.targetError = 0.5;
   //  var group = new THREE.Group();
   //  group.add(nexus_obj);
   scene.add(nexus_obj);

    function loadFbx() {
        //   THREE.Loader.Handlers.add(/\.tga$/i, new THREE.TGALoader());

        /**
         *读取man动画模型,animations::0:行走,1:奔跑, 2:转头
         */

        var loader1 = new THREE.FBXLoader();

        loader1.load( '../models/fbx/test/m_1.FBX', function ( object ) {
            object.mixer = new THREE.AnimationMixer( object );   //场景中特定对象的动画播放器

            var action = object.mixer.clipAction( object.animations[ 1 ] );  //返回可以控制动画的对象
            action.play(); //启动动画动作

            object.rotation.y = Math.PI/2;
            object.scale.multiplyScalar(0.001); //缩放
            //let positoin = [-0.06,-0.1,0.007];
            let positoin = [-0.0,-0.0,0.0];
            object.position.x = positoin[0]-0.086;
            object.position.y = positoin[1];
            object.position.z = positoin[2]+0.00;


            // object.traverse( function ( child ) {  //设置模型的每个部位都可以投影
            //
            //     if ( child.isMesh ) {
            //
            //         child.castShadow = true;
            //         child.receiveShadow = true;
            //
            //     }
            //
            // } );
            object.children[10].visible = false;
            object.children[10].color = {r:0.1,g:0.1,b:0.1};
           // scene.add( object );

        } );


        loader1.load( '../models/fbx/test/man_all_action.FBX', function ( object ) {
            mix = object.mixer = new THREE.AnimationMixer( object );   //场景中特定对象的动画播放器
           // mixers.push( object.mixer );

            var action = object.mixer.clipAction( object.animations[ 0 ] );  //返回可以控制动画的对象 .行走
            action.play(); //启动动画动作
            //let action;
            //for(let i = 0;i < object.animations.length;i++){
            //    action = object.mixer.clipAction(object.animations[i]);
            //    actionsMan.push(action);
            //}

            object.rotation.y = Math.PI/2;
           // object.rotation.x = Math.PI/2;
            object.scale.multiplyScalar(0.001); //缩放
            //let positoin = [-0.6,-0.07,0.018];
            let positoin = [0,0,0.];
            object.position.x = positoin[0]-0.8;
            object.position.y = positoin[1];
            object.position.z = positoin[2]+0.2;

            object.children[10].visible = false;
            object.children[10].color = {r:0.1,g:0.1,b:0.1};

       //     scene.add( object );

        } );

    }
     var helper = new THREE.AxesHelper(5); //辅助坐标轴

    var  loaderfont = new THREE.FontLoader();
    loaderfont.load( 'font/FangSong_Regular.json', function ( response ) {
        //注意response 这内容比较关键，是否能加载中文就看这个变量了，这个变量里面的glyphs，默认的几种只有英文
        var options = {
            size: 1.0, //字号大小，一般为大写字母的高度
            height: 0.5, //文字的厚度
            weight: 'normal', //值为'normal'或'bold'，表示是否加粗
            font: response, //字体，默认是'helvetiker'，需对应引用的字体文件
            style: 'normal', //值为'normal'或'italics'，表示是否斜体
            bevelThickness: 0.01, //倒角厚度
            bevelSize: 0.01, //倒角宽度
            curveSegments: 30,//弧线分段数，使得文字的曲线更加光滑
            bevelEnabled: true, //布尔值，是否使用倒角，意为在边缘处斜切
        };
        ////创建一个三维对象的文本作为一个单一的对象 text输入的文字 options 文字设置
        var textGeo = new THREE.TextGeometry( "北航青岛研究院", options);
        textGeo.computeBoundingBox();
        textGeo.computeVertexNormals();
        var centerOffset = -0.5 * ( textGeo.boundingBox.max.x - textGeo.boundingBox.min.x );

        var material = new THREE.MultiMaterial([
            new THREE.MeshPhongMaterial( { color: 0x00ffff, shading: THREE.FlatShading } ), // front
            new THREE.MeshPhongMaterial( { color: 0x00ffff, shading: THREE.SmoothShading } ) // side
        ]);
        //新建mesh,加入
        mesh = new THREE.Mesh( textGeo, material );
        mesh.position.x = -0.28;
        mesh.position.y = 0.2;
        mesh.position.z = 0;

        mesh.scale.multiplyScalar(.05); //模型缩放
        mesh.rotation.x = -Math.PI /10;
        mesh.rotation.y = Math.PI * 2;


        scene.add( mesh );


    } );




    var textureLoader = new THREE.TextureLoader();
    var texture = textureLoader.load("models/jiantou003.jpg");

    loader.load("models/jiantou003.obj",function (object) {
        object.traverse(function (child) { //遍历读入模型的每一个mesh到child
            if (child instanceof THREE.Mesh) {  //判断child是否是mesh类型.instanceof类似与typeof,返回准确的数据类型
                child.material.map = texture;
                child.material.transparent = true;
                //child.material.opacity = 0.8;
            }
        });
        //object.material.depthTest = false;
         object.position.x  =-0.06220;
         object.position.y  = -0.00820;
         object.position.z  = -0.05;
        object.scale.multiplyScalar(0.025); //模型缩放
        scene.add(object);

    });

    //document.addEventListener("mousedown",onDocumentMouseDown,false); //关闭对html事件的相应
    document.addEventListener("touchstart",onDocumentTouchStart,false);  //当手指触摸屏幕时触发
    window.addEventListener( 'resize', onWindowResize, false );
    window.addEventListener("click",onMouseClick,false);

    var geometry = new THREE.SphereBufferGeometry(0.005,48,48);
    var material = new THREE.MeshBasicMaterial({color:0xffff00});
    var sphere3  =  new THREE.Mesh(geometry,material);
    sphere3.position.set(0.07,0.08,0.21);
    sphere3.name = "3";
    //shpere.visible = false;
    sphere3.material.transparent = true;
    material.opacity = 0.5;


   // var geometry1 = geometry.clone();
    var material = new THREE.MeshBasicMaterial({color:0xffff00});
    material.transparent = true;
    material.opacity = 0.5;
    var sphere4 =  new THREE.Mesh(geometry,material);
    sphere4.position.set(-0.14,0.08,0.2);
    sphere4.name ="4";


    var material = new THREE.MeshBasicMaterial({color:0xffff00});
    material.transparent = true;
    material.opacity = 0.5;
    var sphere5 =  new THREE.Mesh(geometry,material);
    sphere5.position.set(-0.36,0.08,0.13);
    sphere5.name ="5";


    var material = new THREE.MeshBasicMaterial({color:0xffff00});
    material.transparent = true;
    material.opacity = 0.5;
    var sphere1 =  new THREE.Mesh(geometry,material);
    sphere1.position.set(0.207,0.108,-0.18);
    sphere1.name ="1";

    var material = new THREE.MeshBasicMaterial({color:0xffff00});
    material.transparent = true;
    material.opacity = 0.5;
    var sphere2 =  new THREE.Mesh(geometry,material);
    sphere2.position.set(0.109,0.108,-0.02);
    sphere2.name ="2";


    var material = new THREE.MeshBasicMaterial({color:0xffff00});
    material.transparent = true;
    material.opacity = 0.5;
    var sphere6 =  new THREE.Mesh(geometry,material);
    sphere6.position.set(-0.52,0.073,0.02);
    sphere6.name ="6";

    var material1 = new THREE.MeshBasicMaterial({color:0xff00ff});
    // material1.transparent = true;
    // material1.opacity = 0.8;
    var sphere7 =  new THREE.Mesh(geometry,material1);
    sphere7.position.set(-0.095,0.001,0.22);
    sphere7.name ="7";

    var group = new THREE.Group();

    group.add(sphere1);
    group.add(sphere2);
    group.add(sphere3);
    group.add(sphere4);
    group.add(sphere5);
    group.add(sphere6);
    group.add(sphere7);

    for(var i = 1; i<8;i++) {
        var textDiv = document.createElement('div');
        textDiv.className = 'label';
        //textDiv.textContent = i+"#";
            if(1 == i)
                textDiv.innerHTML = '<style>p{background:#666666;}</style><p>1# 职工公寓</p>'
                //textDiv.textContent+="职工公寓"
            else if (2 == i)
                textDiv.innerHTML = '<style>p{background:#666666;}</style><p>2# 学生公寓</p>'
                //textDiv.textContent+="学生公寓"
            else if (3 == i)
                textDiv.innerHTML = '<style>p{background:#666666;}</style><p>3# 虚拟现实研究院</p>'
                //textDiv.textContent+="虚拟现实研究院"
            else if (4 == i)
                textDiv.innerHTML = '<style>p{background:#666666;}</style><p>4# 办公楼</p>'
                // textDiv.textContent+="办公楼"
            else if (5 == i)
                textDiv.innerHTML = '<style>p{background:#666666;}</style><p>5# 教学楼</p>'
                // textDiv.textContent+="教学楼"
            else if(6 == i){
                textDiv.innerHTML = '<style>p{background:#666666;}</style><p>6# 微电子研究院</p>'
                //textDiv.innerText='微电子'
            } else {
                textDiv.innerHTML = '<style>p{background:#666666;}</style><p> VR展厅</p>'
            }
                // textDiv.innerText='<style>p{background:#f00;}'+" 微电子研究院" +'\r\n'+"军民融合研究院"
        textDiv.style.marginTop = '-1em';
        textDiv.style.color = 'rgb(250,250,250)';
        var textLabel = new THREE.CSS2DObject(textDiv);
        textLabel.position.set(0, 0.0, 0);
        group.children[i-1].add(textLabel);
    }
    //sphere2.add(textLabel);




    //group.add(textLabel);
    scene.add(group);


    labelRenderer = new THREE.CSS2DRenderer();
    labelRenderer.setSize( window.innerWidth, window.innerHeight );
    labelRenderer.domElement.style.position = 'absolute';
    labelRenderer.domElement.style.top = 0;
    //document.body.appendChild( labelRenderer.domElement );
    container.appendChild( labelRenderer.domElement );
    var content = '<div id = "main" style="padding: 10px;color: #FFF;font-size: 10px;">'+
        '<div id = "main1" style="width:100%;height:100px;overflow:auto;">'+
        '<table style="float:top;width:100%;height:100%;">'+
        '<tr><td style="width:60px;">名称:</td><td>北京航空航天大学青岛研究院</td></tr>'+
        '<tr><td style="width:60px;">当前位置:</td><td id = "test">3号楼</td></tr>'+
        '<tr><td style="width:60px;">简介:</td><td> ......</td></tr>'+
        '</table>'+
        '</div>'+
       // '< style="float:bottom;width:100%;">'+
        '<a href="https://720yun.com/t/a30jrzmfev9?scene_id=27096172" target = "_blank" style="float:left;margin-left:30px;">全景视频</a>'+
        //  '<a href = "javascript:void(0)" onclick="fun_a()" target="_blank">全景视频</a>'+
        '<video src = "./video/00.mkv" controls="controls" width="200" height="200">视频查看</video>'+
        '<img src="./img/DJI_0001.JPG" height="200" width="200">'+
        //'</div>'+
        '</div>';

    var mouse = new THREE.Vector2();
    raycaster = new THREE.Raycaster();
    function onMouseClick(event){
        event.preventDefault();
        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
        raycaster.setFromCamera( mouse, camera );

        var intersections = raycaster.intersectObjects( group.children);
        if(intersections.length == 1) {
            if(intersections[0].object.name == "3") {
                    intersections[0].object.material.color.set(0xff0000);
                    createInfo(event);
                    let tem = document.getElementById("main");
                    var t = 0;
            }else if(intersections[0].object.name == "4"){
                intersections[0].object.material.color.set(0xff0000);
                createInfo(event);
                let test = document.getElementById('test');
                test.firstChild.data = "4号楼";

            }else if(intersections[0].object.name == "5"){
                intersections[0].object.material.color.set(0xff0000);
                createInfo(event);
                let test = document.getElementById('test');
                test.firstChild.data = "5号楼";

            }else if(intersections[0].object.name == "1"){
                intersections[0].object.material.color.set(0xff0000);
                createInfo(event);
                let test = document.getElementById('test');
                test.firstChild.data = "1号楼";

            }else if(intersections[0].object.name == "2"){
                intersections[0].object.material.color.set(0xff0000);
                createInfo(event);
                let test = document.getElementById('test');
                test.firstChild.data = "2号楼";

            }else if (intersections[0].object.name == "6"){
                intersections[0].object.material.color.set(0xff0000);
                createInfo(event);
                let test = document.getElementById('test');
                test.firstChild.data = "6号楼";
            }



        }
        else {
            for(var i = 0;i<group.children.length;i++){
                group.children[i].material.color.set(0xffff00);
            }

            let div = document.getElementById("Box");
            if(div){
                document.body.removeChild(div);
            }
        }

    }

    function  fun_a() {
        location.href="https://720yun.com/t/a30jrzmfev9?scene_id=27096172";

    }


    function createInfo(ev){
            var mDiv = document.getElementById('Box');
            if(mDiv){
                document.body.removeChild(mDiv);
            }
            var oEvent=ev||event;
            var oDiv=document.createElement('div');
            oDiv.id = "Box";
            // oDiv.style.left=(oEvent.clientX-130)+'px';  // 指定创建的DIV在文档中距离左侧的位置
            oDiv.style.right=(10)+'px';  // 指定创建的DIV在文档中距离左侧的位置
            oDiv.style.top=(oEvent.clientY-145)+'px';  // 指定创建的DIV在文档中距离顶部的位置
            oDiv.style.border='1px solid #0000FF'; // 设置边框
            oDiv.style.borderRadius = '25px';
            oDiv.style.background='rgba(0,0,0,0.5)';
            oDiv.style.position='absolute'; // 为新创建的DIV指定绝对定位
            oDiv.style.width='260px'; // 指定宽度
            oDiv.style.height='335px'; // 指定高度
            // var content = '<div style="padding: 10px;color: #FFF;font-size: 10px;">'+
            //     '<div style="width:100%;height:100px;overflow:auto;">'+
            //     '<table style="float:top;width:100%;height:100%;">'+
            //     '<tr><td style="width:60px;">名称:</td><td>北京航空航天大学青岛研究院</td></tr>'+
            //     '<tr><td style="width:60px;">当前位置:</td><td>3号楼</td></tr>'+
            //     '<tr><td style="width:60px;">简介:</td><td> 。。。。。。</td></tr>'+
            //     '</table>'+
            //     '</div>'+
            //   //  '< style="float:bottom;width:100%;">'+
            //     '<a href="https://720yun.com/t/a30jrzmfev9?scene_id=27096172" target = "_blank" style="float:left;margin-left:30px;">全景视频</a>'+
            //     '<img src="./img/DJI_0001.JPG" height="200" width="200">'+
            //   //  '<a href = "javascript:void(0)" onclick="fun_a()" target="_blank">全景视频</a>'+
            //   //  '<a onclick="window.location.href" ="./threejs_1.html" href="#" style="float:right;margin-right:30px;">视频查看</a>'+
            //     '</div>'+
            //     '</div>';
            oDiv.innerHTML = content;
            document.body.appendChild(oDiv);

    }


    render();

    //objects.push(nexus_obj);


    function onDocumentTouchStart( event ) {
        event.preventDefault();
        event.clientX = event.touches[0].clientX;
        event.clientY = event.touches[0].clientY;
        onDocumentMouseDown( event );
    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

       // controls.handleResize();
        controls.update();

        render();
    }

    var btmp = false;

    var b_camera = false;
    var value= 0;
    function cameraPath() {
        value+=clock.getDelta()*0.2;
        // camera.position.set(0,-2,value);
        //camera.lookAt({x:value,y:0,z:value});
        //nexus_obj.position.x+=0.0001;
        nexus_obj.rotation.y = value;
        //group.rotation.y = value;
     //  group.applyMatrix4( this.makeRotationAxis((0,1,0),value));

    }
    function animate() {
        controls.update();
        render();
        requestAnimationFrame( animate );
        labelRenderer.render(scene,camera);
     //   mix.update( clock.getDelta() );
        //   THREE.AnimationHandler.update(clock.getDelta());
        if (b_camera)
            cameraPath();
    }

    function render() {
        Nexus.beginFrame(renderer.context);
        renderer.render( scene, camera );
        Nexus.endFrame(renderer.context);
    }


    function actionsToolbar(action) {
        if(action=='home')
        {
            //controls.reset();
            controls.reset();
        }
        else if (action == "zoomin"){
            //controls.action = 2;
            camControls.enabled = false;
            // controls.track(controls.viewMatrix,0.0,0.0,1.1);
        }
        else if (action=="light" || action =="light_on" ){
            $('#light').css("visibility", "hidden");
            $('#light_on').css("visibility", "visible");
            //nexus_obj.visible = true;
            //nexus_obj1.visible = false;
            b_camera = false;
            //_spidergl.postDrawEvent();
        }
        else if(action=="measure"||action == "measure_on")
        {
            b_camera = true;
        }

    }


    //判断是否是手机端（若是pc返回true，否则返回false）
    function IsPC() {
        var userAgentInfo = navigator.userAgent;
        var Agents = ["Android", "iPhone",
            "SymbianOS", "Windows Phone",
            "iPad", "iPod"];
        var flag = true;
        for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                flag = false;
                break;
            }
        }
        return flag;
    }

    var flag = IsPC(); //true为PC端，false为手机端
    console.log(flag);

    init3D();
    animate();
    //   $('#measure-output').html(measure.toFixed(2) + " mm");

</script>


</html>

