<!DOCTYPE html>
<html lang="en">
	<title>threejs_1 </title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>body { margin: 0px; overflow: hidden; }</style>
	<link type="text/css" rel="stylesheet" href="stylesheet/3dhop.css"/> <!--链接样式表sst的通用方式 -->

	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.js"></script>-->
	<script src="../js/three.js"></script>

	<script src="../js/libs/CanvasRenderer.js"></script>
	<!--JQUERY-->
	<script src="js/jquery.js"></script>
	<script src="js/TrackballControls.js"></script>
	<script src ="js/FirstPersonControls.js"></script>
	<script src = "../js/controls/PathControls.js"></script>

	<script src="js/nexus.js"></script>
	<script src="js/nexus_three.js"></script>
	<script src = "../js/libs/stats.min.js"></script>
	<script src = "../js/libs/dat.gui.min.js"></script>

	<script src="../js/libs/inflate.min.js"></script>
	<script src="../js/loaders/FBXLoader.js"></script>

	<script src = "js/init.js"></script>

	<script src="../js/libs/inflate.min.js"></script>
	<script src="../js/loaders/TGALoader_dev.js"></script>

</head>

<body>
	<div id="container"></div>
	<!--<canvas id="container"></canvas>-->
	<div id="event" class ="3DModel" onmousedown="if(event.preventDefault) event.preventDefault() "></div>
	<div id="toolbar">
		<img id="home" 		 	title="Home" 					src="img/dark/home.png"/><br/>
		<img id="zoomin" 	    title="Zoom In"					src="img/dark/zoomin.png"/><br/>
		<img id="light_on"      title="Disable Light Control"   src="img/dark/lightcontrol_on.png" style="position:absolute; visibility:hidden;"/>
		<img id="light"      	title="Enable Light Control"    src="img/dark/lightcontrol.png"    /><br/>
		<img id="measure_on"	title="Disable Measure tool"	src="img/dark/measure_on.png" style="..."/>
		<!--<img id="measure"		title="Enable Measure tool"		src="img/dark/measure.png"/><br/>-->

	</div>

	<div id="measure-box" class="output-box">Measured length<hr/><span id="measure-output" class="output-text" onmousedown="event.stopPropagation()">0.0</span></div>

</body>

<script>
    var container = document.getElementById( 'container');
    var renderer,scene,camera;
    var stats,controls;

    var raycaster,mouse,particleMaterial;

    var clock = new THREE.Clock();
    var cloc1 = new THREE.Clock();

    renderer= new THREE.WebGLRenderer( { antialias: false } );
    renderer.setClearColor( 0xffffff );
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( window.innerWidth, window.innerHeight);
    //document.getElementById('container').appendChild(renderer.domElement);

    container.appendChild( renderer.domElement );


    camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.001, 1000 );
//	camera.position.z = 2.2;
	camera.position.set(0.1228620,0.098,0.4567); //北航研究院
//	camera.position.set(0,-1,0.5); //天津
	//camera.lookAt({x:0,y:0,z:0});
/*
	function getPath(){
	    var points = [];
	    var r = 10;
        var cX = 0;
        var cY = 0;

        for (var i = 0 ; i < 100 ; i += 5){

            var x = r * Math.cos(i * (Math.PI / 180)) + cX;
            var z = r * Math.sin(i * (Math.PI / 180)) + cY;
            var y = i / 30;

            points.push(new THREE.Vector3(x,y,z));
        }

        return points;
	}

    var pathControls = new THREE.PathControls(camera);

    //配置pathControls
    pathControls.duration = 70;
    pathControls.useConstantSpeed = true;
    pathControls.lookSpeed = 0.1;
    pathControls.lookVertical = true;
    pathControls.lookHorizontal = true;
    pathControls.verticalAngleMap = {
        srcRange:[0,2*Math.PI],
        dsRange:[1.1,3.8]
    };
    pathControls.horizontalRange = {
        srcRange:[0,2*Math.PI],
        dsRange:[0.3,Math.PI - 0.3]
    };
    pathControls.waypoints=[[-5,0,0],[0,-5,0],[0,0,0]]
    pathControls.lon = 300;
    pathControls.lat = 40;
*/
    //添加路径
    // controls.points.forEach(function(e){
    //     pathControls.wayPoints.push([e.x,e.y,e.z]);
    // });

    //初始化控件
  //  pathControls.init();

   // pathControls.animation.play(true,0);

    var camControls = new THREE.FirstPersonControls(camera);
    camControls.enabled = true;
    camControls.lookVertical = false;//设置是否允许摄像头上下移动
    camControls.lookSpeed = 0.04;
    camControls.movementSpeed = 0.05;
    camControls.noFly = true;
    camControls.lookVertical = true;
    camControls.constrainVertical = true;
    camControls.verticalMin = 1;
    camControls.verticalMax = 2;
    camControls.lon = 270;
    camControls.lat = 0;
    //camControls.phi = -100;
    //camControls.theta = 100;


	scene = new THREE.Scene();
    // var helper = new THREE.AxesHelper(5); //辅助坐标轴
    // scene.add(helper);

    //开始动画，保证相机可以自动移动
   // scene.add(pathControls.animationParent);

	//scene.fog = new THREE.Fog( 0x050505, 2000, 3500 );
	scene.add( new THREE.AmbientLight( 0x222222 ) );

	var light1 = new THREE.DirectionalLight( 0xdddddd, 1.0 );
	light1.position.set( 0, 1, 1 );
	scene.add( light1 );

	var light2 = new THREE.DirectionalLight( 0x999999, 1.0 );
	light2.position.set( -1, -1, 0 );
	scene.add( light2 );

	function getURLParameter(name) {
		return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
	}

	//var model = getURLParameter('model') || "models/tianjin_jpg.nxz";   //corto压缩后
   // var model = getURLParameter('model') || "models/bhqditi_yxg_y.nxz";
	//var model = getURLParameter('model') || "models/bhqditi_new_4000_simplified_3d_mesh_yxg.nxz";
  //  var model = getURLParameter('model') || "models/bhqditi_yxg.nxz";  //移除

	var model1 = getURLParameter('model') || "models/xx.nxz";
	//var nexus_obj = new NexusObject(model, renderer, render);

    var nexus_obj1 = new NexusObject( model1, renderer, render /*,material*/);
//	var nexus_obj = new NexusObject( model, renderer, render /*,material*/);
    //  var group = new THREE.Group();
    //  group.add(nexus_obj);
	// scene.add(nexus_obj);
	// nexus_obj1.position.y = -1;
    // nexus_obj1.position.z = -0;
    // nexus_obj1.position.x = 0;
	 scene.add(nexus_obj1);
	// nexus_obj1.visible = false;


/*
    // FBX model
	var mixers = [];
    var loader1 = new THREE.FBXLoader();
   // loader1.load( '../models/fbx/Samba Dancing.fbx', function ( object ) {
    loader1.load( '../models/fbx/FBX 2013/man_test.FBX', function ( object ) {
        object.mixer = new THREE.AnimationMixer( object );   //场景中特定对象的动画播放器
        mixers.push( object.mixer );

        var action = object.mixer.clipAction( object.animations[ 0 ] );  //返回可以控制动画的对象
        action.play(); //启动动画动作

        object.rotation.x = Math.PI/2;
        object.scale.multiplyScalar(0.001); //缩放
        //let positoin = [-0.06,-0.1,0.007];
        let positoin = [-0.6,-0.07,0.018];
			object.position.x = positoin[0]-0.06;
        	object.position.y = positoin[1];
        	object.position.z = positoin[2]+0.001;


        object.traverse( function ( child ) {  //设置模型的每个部位都可以投影

            if ( child.isMesh ) {

                child.castShadow = true;
                child.receiveShadow = true;

            }

        } );

         scene.add( object );

    } );
*/
/*
    var mixers2 = [];
    var loader2 = new THREE.FBXLoader();
    function anit (obj){

	}

    THREE.Loader.Handlers.add(/\.tga$/i, new THREE.TGALoader());
    loader2.load( '../models/fbx/FBX 2013/aaajpg.FBX', function( object ) {
        object.mixer = new THREE.AnimationMixer( object );   //场景中特定对象的动画播放器
        mixers2.push( object.mixer );

        var action = object.mixer.clipAction( object.animations[ 0 ] );  //返回可以控制动画的对象
        action.play(); //启动动画动作

        object.rotation.y = Math.PI/2;
        object.rotation.x = Math.PI/2;

        object.scale.multiplyScalar(0.001); //缩放
        let positoin = [-0.65,-0.07,0.018];
        object.position.x = positoin[0];
        object.position.y = positoin[1];
        object.position.z = positoin[2];


        object.traverse( function ( child ) {  //设置模型的每个部位都可以投影

            if ( child.isMesh ) {

                child.castShadow = true;
                child.receiveShadow = true;

            }

        } );

        fbx1 = object;
        scene.add( object );

    } );
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    */
	//document.addEventListener("mousedown",onDocumentMouseDown,false); //关闭对html事件的相应
	document.addEventListener("touchstart",onDocumentTouchStart,false);  //当手指触摸屏幕时触发
    window.addEventListener("click",onMouseDown,false);
	window.addEventListener( 'resize', onWindowResize, false );
	render();

	function onMouseDown() {
		console.log(camera.position);
		console.log(camera);
    }

    //objects.push(nexus_obj);

    function onDocumentTouchStart( event ) {
        event.preventDefault();
        event.clientX = event.touches[0].clientX;
        event.clientY = event.touches[0].clientY;
        onDocumentMouseDown( event );
    }

	function onWindowResize() {

		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();

		renderer.setSize( window.innerWidth, window.innerHeight );

		// controls.handleResize();
		 //controls.update();
		camControls.handleResize();
		camControls.update();
		render();
	}

	var btmp = false;
	function animate() {
         render();
		/*
        //fbx骨骼动画
        if ( mixers.length > 0 ) {

            for ( var i = 0; i < mixers.length; i ++ ) {

                mixers[ i ].update( clock.getDelta() );
                if (mixers[i]._root.position.x < 0.123)
                    mixers[i]._root.position.x += 0.0002;
                // if (mixers[i]._root.position.x + 0.025 > 0.000001){
                //     mixers[i]._root.position.y = -0.07-0.02;
                //     mixers[i]._root.position.z = 0.018 - 0.005;
                // }
                else
                    mixers[i]._root.position.x -= 0.0004;

            }

        }
        //fbx1.position.x += 0.001;

        if ( mixers2.length > 0 ) {

            for ( var i = 0; i < mixers2.length; i ++ ) {

                mixers2[ i ].update( cloc1.getDelta() );
				if (mixers2[i]._root.position.x < 0.123){
                	mixers2[i]._root.position.x += 0.0002;
                	if (mixers2[i]._root.position.x + 0.025 > 0.000001){
                        mixers2[i]._root.position.y = -0.07-0.02;
                        mixers2[i]._root.position.z = 0.018 - 0.005;
                	}
				}
                else
                    // (mixers2[i]._root.position.x > 0.132){
                    mixers2[i]._root.position.x -= 0.0004;


            }

        }
*/
		requestAnimationFrame( animate );
     //   THREE.AnimationHandler.update(clock.getDelta());
		// pathControls.update(clock.getDelta());
	//	controls.update();
		camControls.update(clock.getDelta());
	}

	function render() {
		Nexus.beginFrame(renderer.context);
		renderer.render( scene, camera );
		Nexus.endFrame(renderer.context);
	}


	function actionsToolbar(action) {
        if(action=='home')
		{
		    //controls.reset();
		    camControls.reset();
		}
		else if (action == "zoomin"){
		    //controls.action = 2;
            camControls.enabled = false;
		   // controls.track(controls.viewMatrix,0.0,0.0,1.1);
		}
		else if (action=="light" || action =="light_on" ){
            $('#light').css("visibility", "hidden");
            $('#light_on').css("visibility", "visible");
            nexus_obj.visible = true;
            nexus_obj1.visible = false;
            //_spidergl.postDrawEvent();
		}
		else if(action=="measure"||action == "measure_on")
		{
		    console.log("adf");
            nexus_obj.visible = false;
            nexus_obj1.visible = true;
		}

	}


	//判断是否是手机端（若是pc返回true，否则返回false）
    function IsPC() {
        var userAgentInfo = navigator.userAgent;
        var Agents = ["Android", "iPhone",
            "SymbianOS", "Windows Phone",
            "iPad", "iPod"];
        var flag = true;
        for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                flag = false;
                break;
            }
        }
        return flag;
    }

    var flag = IsPC(); //true为PC端，false为手机端
	console.log(flag);

    init3D();
    animate();
 //   $('#measure-output').html(measure.toFixed(2) + " mm");

</script>


</html>

